<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QuantumXP Payment System</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Font: Orbitron (Futuristic Header) & Noto Sans Thai (Content) -->
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Noto+Sans+Thai:wght@400;700&display=swap" rel="stylesheet">
    
    <style>
        /* ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Ñ‡πà‡∏≤‡∏™‡∏µ‡∏´‡∏•‡∏±‡∏Å‡πÅ‡∏•‡∏∞‡∏ü‡∏≠‡∏ô‡∏ï‡πå */
        :root {
            --color-gold: #FFD700;
            --color-black: #000000;
            --color-gray-dark: #1a1a1a;
            --color-gray-light: #333333;
        }

        /* ‡πÉ‡∏ä‡πâ‡∏ü‡∏≠‡∏ô‡∏ï‡πå Orbitron ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏´‡∏±‡∏ß‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á ‡πÅ‡∏•‡∏∞ Noto Sans Thai ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤ */
        body {
            font-family: 'Noto Sans Thai', sans-serif;
            background-color: var(--color-black);
            color: var(--color-gold);
            overflow-x: hidden;
            
            /* üéØ NEW: ‡πÄ‡∏û‡∏¥‡πà‡∏° pattern ‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á‡πÅ‡∏ö‡∏ö grid ‡∏ï‡∏≤‡∏°‡∏ò‡∏µ‡∏° */
            /* ‡∏™‡∏£‡πâ‡∏≤‡∏á grid dots ‡∏™‡∏µ‡πÄ‡∏ó‡∏≤‡∏à‡∏≤‡∏á‡πÜ (‡πÄ‡∏Ç‡πâ‡∏≤‡∏Å‡∏±‡∏ö‡∏ò‡∏µ‡∏° tech) */
            background-image: radial-gradient(rgba(255, 255, 255, 0.05) 1px, transparent 1px);
            background-size: 1.5rem 1.5rem; /* ‡∏Ç‡∏ô‡∏≤‡∏î‡∏Ç‡∏≠‡∏á grid (24px) */
            background-position: 0 0;
        }

        h1, h2, h3, h4, h5, h6, .font-orbitron {
            font-family: 'Orbitron', sans-serif;
        }

        /* ‡πÄ‡∏≠‡∏ü‡πÄ‡∏ü‡∏Å‡∏ï‡πå‡πÄ‡∏£‡∏∑‡∏≠‡∏á‡πÅ‡∏™‡∏á (Glow Effect) */
        .glow-gold {
            text-shadow: 0 0 8px var(--color-gold), 0 0 12px var(--color-gold), 0 0 16px rgba(255, 215, 0, 0.7);
        }
        
        .glow-gold-soft {
            text-shadow: 0 0 6px rgba(255, 215, 0, 0.5);
        }

        .btn-primary {
            background-color: var(--color-gold);
            color: var(--color-black);
            font-family: 'Orbitron', sans-serif;
            font-weight: 700;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            transition: all 0.3s ease;
            border: 2px solid var(--color-gold);
            box-shadow: 0 0 10px rgba(255, 215, 0, 0.3), 0 0 20px rgba(255, 215, 0, 0.2);
            animation: pulse-sm 2.5s infinite;
        }

        .btn-primary:hover {
            background-color: var(--color-black);
            color: var(--color-gold);
            box-shadow: 0 0 15px rgba(255, 215, 0, 0.7), 0 0 25px rgba(255, 215, 0, 0.5);
            animation-play-state: paused;
        }

        .btn-secondary {
            background-color: transparent;
            color: var(--color-gold);
            font-family: 'Orbitron', sans-serif;
            font-weight: 700;
            padding: 0.6rem 1.25rem;
            border-radius: 0.5rem;
            transition: all 0.3s ease;
            border: 2px solid var(--color-gold);
        }

        .btn-secondary:hover {
            background-color: var(--color-gold);
            color: var(--color-black);
        }
        
        .btn-approve {
            background-color: #22c55e; /* green-500 */
            color: white;
            box-shadow: 0 0 10px rgba(34, 197, 94, 0.5);
        }
        .btn-approve:hover {
            background-color: #16a34a; /* green-600 */
        }
        
        .btn-reject {
            background-color: #ef4444; /* red-500 */
            color: white;
            box-shadow: 0 0 10px rgba(239, 68, 68, 0.5);
        }
        .btn-reject:hover {
            background-color: #dc2626; /* red-600 */
        }

        /* üéØ ADDED: SVG Icon Glow */
        .icon-glow {
            stroke: var(--color-black); /* üéØ UPDATED: ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡∏™‡∏µ‡∏î‡∏≥‡∏ï‡∏≤‡∏°‡∏Ñ‡∏≥‡∏Ç‡∏≠ */
            filter: drop-shadow(0 0 4px rgba(255, 215, 0, 0.7)) drop-shadow(0 0 7px rgba(255, 215, 0, 0.5));
            transition: all 0.3s ease;
        }
        .btn-primary:hover .icon-glow {
            stroke: var(--color-gold); /* üéØ UPDATED: ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡∏™‡∏µ‡∏ó‡∏≠‡∏á‡πÄ‡∏°‡∏∑‡πà‡∏≠ hover */
            /* On hover, the button background becomes black, so the gold icon will stand out */
            /* We can make the glow a bit stronger */
            filter: drop-shadow(0 0 7px var(--color-gold)) drop-shadow(0 0 10px rgba(255, 215, 0, 0.8));
        }
        /* üéØ END ADDED */


        /* ‡∏™‡πÑ‡∏ï‡∏•‡πå‡∏ü‡∏≠‡∏£‡πå‡∏° */
        .form-input {
            background-color: var(--color-gray-light);
            border: 1px solid var(--color-gold);
            color: #FFFFFF;
            border-radius: 0.375rem;
            padding: 0.75rem 1rem;
            transition: all 0.3s ease;
            width: 100%;
        }
        
        .form-input::placeholder {
            color: #9ca3af; /* gray-400 */
        }

        .form-input:focus, .form-select:focus { /* üéØ UPDATED: ‡πÄ‡∏û‡∏¥‡πà‡∏° .form-select ‡πÅ‡∏•‡∏∞‡∏õ‡∏£‡∏±‡∏ö‡πÄ‡∏≠‡∏ü‡πÄ‡∏ü‡∏Å‡∏ï‡πå */
            outline: none;
            border-color: var(--color-gold); /* ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏µ‡∏Ç‡∏≠‡∏ö‡πÄ‡∏õ‡πá‡∏ô‡∏™‡∏µ‡∏ó‡∏≠‡∏á‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÇ‡∏ü‡∏Å‡∏±‡∏™ */
            box-shadow: 0 0 15px rgba(255, 215, 0, 0.7), 0 0 25px rgba(255, 215, 0, 0.3); /* üéØ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏≠‡∏ü‡πÄ‡∏ü‡∏Å‡∏ï‡πå‡πÄ‡∏£‡∏∑‡∏≠‡∏á‡πÅ‡∏™‡∏á‡πÉ‡∏´‡πâ‡∏ä‡∏±‡∏î‡∏Ç‡∏∂‡πâ‡∏ô */
        }

        .form-select {
            background-color: var(--color-gray-light);
            border: 1px solid var(--color-gold);
            color: #FFFFFF;
            border-radius: 0.375rem;
            padding: 0.75rem 1rem;
            width: 100%;
            appearance: none;
            /* Custom dropdown arrow using SVG */
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%23FFD700' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
            background-position: right 0.5rem center;
            background-repeat: no-repeat;
            background-size: 1.5em 1.5em;
        }

        /* ‚ùå REMOVED: .form-input:focus (‡∏¢‡πâ‡∏≤‡∏¢‡πÑ‡∏õ‡∏£‡∏ß‡∏°‡∏Å‡∏±‡∏ö .form-select:focus ‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô‡πÅ‡∏•‡πâ‡∏ß) */

        /* ‡∏Å‡∏≤‡∏£‡πå‡∏î */
        .card {
            background-color: var(--color-gray-dark);
            border: 1px solid var(--color-gold);
            border-radius: 0.75rem;
            box-shadow: 0 0 15px rgba(255, 215, 0, 0.1);
            transition: all 0.3s ease;
        }
        .card:hover {
            box-shadow: 0 0 25px rgba(255, 215, 0, 0.3);
        }

        /* üéØ NEW: ‡∏™‡πÑ‡∏ï‡∏•‡πå‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤ Admin */
        .card-admin {
            background-color: var(--color-gray-dark);
            border: 1px solid var(--color-gold);
            border-radius: 0.75rem;
            box-shadow: 0 0 15px rgba(255, 215, 0, 0.1);
            transition: all 0.3s ease;
            overflow: hidden; /* ‡∏ã‡πà‡∏≠‡∏ô‡∏™‡πà‡∏ß‡∏ô‡πÄ‡∏Å‡∏¥‡∏ô‡∏Ç‡∏≠‡∏á header */
            position: relative; /* üéØ ADDED: ‡πÄ‡∏û‡∏¥‡πà‡∏° position relative ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏à‡∏±‡∏î‡∏ß‡∏≤‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ */
        }
        .card-admin:hover {
             box-shadow: 0 0 25px rgba(255, 215, 0, 0.3);
        }

        /* üéØ NEW: ‡∏™‡πà‡∏ß‡∏ô‡∏´‡∏±‡∏ß‡∏Ç‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πå‡∏î Admin ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÄ‡∏≠‡∏ü‡πÄ‡∏ü‡∏Å‡∏ï‡πå‡πÄ‡∏£‡∏∑‡∏≠‡∏á‡πÅ‡∏™‡∏á */
        .card-admin-header {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            background: linear-gradient(145deg, var(--color-gray-light), var(--color-gray-dark)); /* ‡πÑ‡∏•‡πà‡∏™‡∏µ‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á */
            padding: 1rem 1.5rem;
            border-bottom: 2px solid var(--color-gold);
            /* ‡πÄ‡∏≠‡∏ü‡πÄ‡∏ü‡∏Å‡∏ï‡πå‡πÄ‡∏£‡∏∑‡∏≠‡∏á‡πÅ‡∏™‡∏á‡∏™‡∏µ‡∏ó‡∏≠‡∏á */
            box-shadow: 0 4px 20px -5px rgba(255, 215, 0, 0.4); 
        }
        
        @media (min-width: 640px) { /* sm */
            .card-admin-header {
                flex-direction: row;
                justify-content: space-between;
                align-items: center;
            }
        }

        /* üéØ NEW: ‡∏™‡πÑ‡∏ï‡∏•‡πå‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÑ‡∏≠‡∏Ñ‡∏≠‡∏ô‡πÉ‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• */
        .data-icon {
            width: 1rem; /* 16px */
            height: 1rem; /* 16px */
            stroke: var(--color-gold);
            margin-right: 0.75rem; /* 12px */
            display: inline-block;
            vertical-align: middle; /* ‡∏à‡∏±‡∏î‡πÉ‡∏´‡πâ‡∏≠‡∏¢‡∏π‡πà‡∏Å‡∏•‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° */
            flex-shrink: 0;
        }

        /* üéØ NEW: ‡∏™‡πÑ‡∏ï‡∏•‡πå‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏õ‡πâ‡∏≤‡∏¢‡∏Å‡∏≥‡∏Å‡∏±‡∏ö (Label) ‡πÉ‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á */
        .data-label {
            display: flex;
            align-items: center;
            font-weight: 600;
            color: #e5e7eb; /* gray-200 */
        }


        /* Animation */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        @keyframes pulse-sm {
            0%, 100% { box-shadow: 0 0 10px rgba(255, 215, 0, 0.3); }
            50% { box-shadow: 0 0 15px rgba(255, 215, 0, 0.5); }
        }

        .fade-in {
            animation: fadeIn 0.5s ease-out forwards;
        }

        /* Modal / Popup */
        .modal-backdrop {
            background-color: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(5px);
        }
        
        .modal-content {
            background-color: var(--color-gray-dark);
            border: 2px solid var(--color-gold);
            box-shadow: 0 0 30px rgba(255, 215, 0, 0.5);
            max-height: 90vh;
        }
        
        /* Loading Spinner */
        .spinner {
            border-top-color: var(--color-gold);
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>

    <!-- üéØ FIXED: ‡∏¢‡πâ‡∏≤‡∏¢‡∏™‡∏Ñ‡∏£‡∏¥‡∏õ‡∏ï‡πå‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏°‡∏≤‡πÑ‡∏ß‡πâ‡πÉ‡∏ô <head> -->
    <script>
        // === System Constants (‡∏à‡∏≤‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡πÉ‡∏´‡πâ‡∏°‡∏≤) ===
        // üéØ GAS URL: ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö Google Apps Script
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyGgB7Gq23iJVlAYlQ1Naj250hQkllxJM97xi4CLdRMUMXQeOUrFiUt4JynD8rpuSAhFQ/exec";
        // ‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö (‡∏Ñ‡∏ß‡∏£‡∏ñ‡∏π‡∏Å‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢‡πÉ‡∏ô GAS ‡πÅ‡∏ï‡πà‡∏à‡∏∞‡πÉ‡∏ä‡πâ‡∏ï‡∏≤‡∏°‡∏ó‡∏µ‡πà‡πÇ‡∏Ñ‡πâ‡∏î‡∏ï‡πâ‡∏ô‡∏â‡∏ö‡∏±‡∏ö‡∏Å‡∏≥‡∏´‡∏ô‡∏î)
        const ADMIN_PASSWORD = "Jessy271009"; 
        const TRUE_MONEY_BASE_URL = "https://tmn.app.link/FDbs0oeDGXb"; 
        // üéØ ‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤: ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ï‡∏≤‡∏°‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏Ç‡∏≠‡∏á‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ
        const SHOP_EMAIL = "quantumxp.payment@gmail.com"; 

        // === State Variables ===
        let slipData = {
            base64: null,
            fileName: null,
            mimeType: null
        };
        let currentAdminPassword = null; // ‡πÄ‡∏Å‡πá‡∏ö Password ‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å Login ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à
        let confirmCallback = null; // ‡πÄ‡∏Å‡πá‡∏ö Callback ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Modal ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô

        // === DOM Elements (Variables will be assigned in DOMContentLoaded) ===
        let pages, amountInput, feeDisplay, totalDisplay, feeDisplayRow, 
            methodSelect, paymentInfoContainer, promptpayInfo, truemoneyInfo, 
            slipInput, paymentForm, historyForm, adminLoginForm, 
            historyResults, adminResults, adminLoginView, adminDashboardView, 
            historyNameInput, historyEmailInput, nameInput, emailInput;

        // === Utility Functions ===
        // üéØ FIXED: ‡∏¢‡πâ‡∏≤‡∏¢‡∏Ñ‡∏≥‡∏à‡∏≥‡∏Å‡∏±‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ç‡∏≠‡∏á‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏≠‡∏≠‡∏Å‡∏°‡∏≤‡∏ô‡∏≠‡∏Å DOMContentLoaded
        // ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏õ‡πá‡∏ô Global Scope ‡πÅ‡∏•‡∏∞ inline onclick/onerror ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ‡πÑ‡∏î‡πâ

        /**
         * ‡πÅ‡∏™‡∏î‡∏á‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡∏≤‡∏° ID ‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÅ‡∏•‡∏∞‡∏ã‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏≠‡∏∑‡πà‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
         * @param {string} pageId The ID of the page to show.
         */
        function showPage(pageId) {
            if (!pages) pages = document.querySelectorAll('.page'); // Assign if not already
            pages.forEach(page => {
                page.classList.add('hidden');
            });
            const activePage = document.getElementById(pageId);
            if (activePage) {
                activePage.classList.remove('hidden');
            }
            
            // ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÅ‡∏•‡∏∞‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏Ñ‡πà‡∏≤‡∏ò‡∏£‡∏£‡∏°‡πÄ‡∏ô‡∏µ‡∏¢‡∏°‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏Ç‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤ Payment ‡∏´‡∏£‡∏∑‡∏≠ History
            if (pageId === 'payment-page') {
                loadUserData();
                calculateFee(); 
            }
            if (pageId === 'history-page') {
                loadUserData();
                if (historyResults) { // Check if element exists
                    historyResults.innerHTML = '<p class="text-center text-gray-500">‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</p>';
                }
            }
        }

        /**
         * ‡πÅ‡∏™‡∏î‡∏á‡∏´‡∏£‡∏∑‡∏≠‡∏ã‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠ Loading
         * @param {boolean} show True to show, false to hide.
         */
        function showLoading(show) {
            const overlay = document.getElementById('loading-overlay');
            if (overlay) {
                if (show) {
                    overlay.classList.remove('hidden');
                } else {
                    overlay.classList.add('hidden');
                }
            }
        }

        /**
         * ‡πÅ‡∏™‡∏î‡∏á Toast Notification
         * @param {string} message ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á.
         * @param {boolean} [isError=false] True ‡∏´‡∏≤‡∏Å‡πÄ‡∏õ‡πá‡∏ô‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° Error (‡∏™‡∏µ‡πÅ‡∏î‡∏á).
         */
        function showToast(message, isError = false) {
            const toast = document.getElementById('toast-notification');
            const toastMessage = document.getElementById('toast-message');
            
            if (!toast || !toastMessage) return; // Guard clause

            toastMessage.textContent = message;
            toast.classList.remove('hidden', 'bg-green-500', 'bg-red-500');
            
            if (isError) {
                toast.classList.add('bg-red-500');
            } else {
                toast.classList.add('bg-green-500');
            }
            
            setTimeout(() => {
                toast.classList.add('hidden');
            }, 3000);
        }

        /**
         * üéØ FIXED: ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô showConfirmModal ‡∏ó‡∏µ‡πà‡∏´‡∏≤‡∏¢‡πÑ‡∏õ
         * ‡πÅ‡∏™‡∏î‡∏á Modal ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£
         * @param {string} message The message to display.
         * @param {function} onConfirm The callback function to execute on confirmation.
         */
        function showConfirmModal(message, onConfirm) {
            const msgEl = document.getElementById('confirm-modal-message');
            const modalEl = document.getElementById('confirm-modal');
            
            if (msgEl) msgEl.textContent = message;
            confirmCallback = onConfirm; // Store the callback
            if (modalEl) modalEl.classList.remove('hidden');
        }

        /**
         * ‡∏õ‡∏¥‡∏î Modal ‡∏ï‡∏≤‡∏° ID
         * @param {string} modalId The ID of the modal to close.
         */
        function closeModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.classList.add('hidden');
            }

            // üéØ Reset the slip modal state when closing it
            if (modalId === 'slip-viewer-modal') {
                const imgEl = document.getElementById('slip-modal-image');
                const errorEl = document.getElementById('slip-modal-error');
                
                if (imgEl) {
                    imgEl.classList.remove('hidden');
                    imgEl.src = ""; // Clear src to stop loading/retrying
                }
                if (errorEl) {
                    errorEl.classList.add('hidden');
                }
            }
        }

        /**
         * üéØ FIXED: ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô closeConfirmModal ‡∏ó‡∏µ‡πà‡∏´‡∏≤‡∏¢‡πÑ‡∏õ
         * This function closes the confirmation modal and clears the callback.
         */
        function closeConfirmModal() {
            closeModal('confirm-modal');
            confirmCallback = null; // Clear the callback
        }

        /**
         * üéØ FIXED: ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏Ç‡∏≤‡∏î‡∏´‡∏≤‡∏¢‡πÑ‡∏õ
         * ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏•‡∏∞‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏•‡∏á‡πÉ‡∏ô localStorage.
         */
        function saveUserData(name, email) {
            try {
                localStorage.setItem('qxp_user', JSON.stringify({ name, email }));
            } catch (e) {
                console.warn("Could not save user data to localStorage:", e);
            }
        }

        /**
         * üéØ FIXED: ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏Ç‡∏≤‡∏î‡∏´‡∏≤‡∏¢‡πÑ‡∏õ
         * ‡πÇ‡∏´‡∏•‡∏î‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏•‡∏∞‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏à‡∏≤‡∏Å localStorage.
         */
        function loadUserData() {
            try {
                const userData = localStorage.getItem('qxp_user');
                if (userData) {
                    const { name, email } = JSON.parse(userData);
                    if (name && nameInput && historyNameInput) {
                        nameInput.value = name;
                        historyNameInput.value = name;
                    }
                    if (email && emailInput && historyEmailInput) {
                        emailInput.value = email;
                        historyEmailInput.value = email;
                    }
                }
            } catch (e) {
                console.warn("Could not load user data from localStorage:", e);
            }
        }

        /**
         * üéØ FIXED: ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏Ç‡∏≤‡∏î‡∏´‡∏≤‡∏¢‡πÑ‡∏õ
         * ‡∏à‡∏±‡∏î‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÑ‡∏≠‡∏Ñ‡∏≠‡∏ô SVG.
         * @param {string} status The status text.
         * @returns {string} HTML string for the status badge.
         */
        function formatStatus(status) {
            let colorClass = 'bg-gray-500'; // Default
            let iconSvg = `<svg class="w-4 h-4 mr-1.5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M9.879 7.519c1.171-1.025 3.071-1.025 4.242 0 1.172 1.025 1.172 2.687 0 3.712-.203.179-.43.326-.67.442-.745.361-1.45.999-1.45 1.827v.75M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Zm-9 5.25h.008v.008H12v-.008Z" /></svg>`;
            
            if (status === 'approved' || status === '‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥') {
                colorClass = 'bg-green-500'; // ‚úÖ ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß
                iconSvg = `<svg class="w-4 h-4 mr-1.5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75 11.25 15 15 9.75M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" /></svg>`;
                status = '‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥';
            } else if (status === 'pending' || status === '‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥') {
                colorClass = 'bg-yellow-500'; // ‚ö†Ô∏è ‡∏™‡πâ‡∏°
                iconSvg = `<svg class="w-4 h-4 mr-1.5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 6v6h4.5m4.5 0a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" /></svg>`;
                status = '‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥';
            } else if (status === 'rejected' || status === '‡πÑ‡∏°‡πà‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥') {
                colorClass = 'bg-red-500'; // ‚ùå ‡πÅ‡∏î‡∏á
                iconSvg = `<svg class="w-4 h-4 mr-1.5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M18.364 18.364A9 9 0 0 0 5.636 5.636m12.728 12.728A9 9 0 0 1 5.636 5.636m12.728 12.728L5.636 5.636" /></svg>`;
                status = '‡πÑ‡∏°‡πà‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥';
            }
            return `<span class="inline-flex items-center px-3 py-1 text-sm font-bold text-white rounded-full ${colorClass}">${iconSvg} ${status}</span>`;
        }

        /**
         * üéØ FIXED: ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏Ç‡∏≤‡∏î‡∏´‡∏≤‡∏¢‡πÑ‡∏õ
         * ‡πÅ‡∏õ‡∏•‡∏á‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏õ‡πá‡∏ô Base64.
         * @param {File} file The file to convert.
         * @returns {Promise<string>} A promise that resolves with the Base64 string.
         */
        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => resolve(reader.result);
                reader.onerror = error => reject(error);
            });
        }
        
        /**
         * üéØ FIXED: ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏Ç‡∏≤‡∏î‡∏´‡∏≤‡∏¢‡πÑ‡∏õ
         * ‡∏à‡∏±‡∏î‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏•‡∏∞‡πÄ‡∏ß‡∏•‡∏≤.
         * @param {string | Date} dateInput The date input.
         * @returns {string} Formatted date string.
         */
        function formatDateTime(dateInput) {
            try {
                const date = new Date(dateInput);
                if (isNaN(date.getTime()) || !dateInput) {
                    return "‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà"; 
                }
                const isoString = date.toISOString().replace(/\.000Z$/, 'Z');
                return new Date(isoString).toLocaleString('th-TH', {
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit'
                });
            } catch (e) {
                return dateInput; // Fallback
            }
        }
        
        /**
         * üéØ FIXED: ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏Ç‡∏≤‡∏î‡∏´‡∏≤‡∏¢‡πÑ‡∏õ
         * Handles slip image loading error.
         * @param {HTMLImageElement} imgElement The image element that failed to load.
         */
        function handleSlipImageError(imgElement) {
            // 1. Hide the image element that failed
            if (imgElement) {
                imgElement.classList.add('hidden');
            }
            // 2. Show the error message block
            const errorEl = document.getElementById('slip-modal-error');
            if (errorEl) {
                errorEl.classList.remove('hidden');
            }
        }

        /**
         * üéØ FIXED: ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏Ç‡∏≤‡∏î‡∏´‡∏≤‡∏¢‡πÑ‡∏õ
         * Adds event listeners dynamically to slip buttons.
         */
        function addSlipButtonListeners(containerId) {
             const container = document.getElementById(containerId);
             if (!container) return;

             container.querySelectorAll('.btn-show-slip').forEach(btn => {
                btn.removeEventListener('click', handleSlipButtonClick); 
                btn.addEventListener('click', handleSlipButtonClick);
            });
        }

        /**
         * üéØ FIXED: ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏Ç‡∏≤‡∏î‡∏´‡∏≤‡∏¢‡πÑ‡∏õ
         * Handles the click event for dynamically added slip buttons.
         */
        function handleSlipButtonClick(event) {
             const btn = event.currentTarget;
             const url = btn.dataset.slipUrl || '';
             if (url) {
                 showSlipModal(url);
             } else {
                  showToast("‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏™‡∏•‡∏¥‡∏õ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ", true);
             }
        }

        /**
         * üéØ FIXED: ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏Ç‡∏≤‡∏î‡∏´‡∏≤‡∏¢‡πÑ‡∏õ
         * Calculates fee and total based on amount and selected method.
         */
        function calculateFee() {
            // Guard clause if elements aren't ready
            if (!amountInput || !methodSelect || !feeDisplayRow || !feeDisplay || !totalDisplay) return; 

            const amount = parseFloat(amountInput.value) || 0;
            const method = methodSelect.value;
            let fee = 0;

            if (method === 'TrueMoney') {
                fee = Math.min(amount * 0.035, 10);
                feeDisplayRow.classList.remove('hidden'); 
            } else {
                feeDisplayRow.classList.add('hidden'); 
            }
            
            const total = amount + fee;
            
            feeDisplay.textContent = `${fee.toFixed(2)} ‡∏ö‡∏≤‡∏ó`;
            totalDisplay.textContent = `${total.toFixed(2)} ‡∏ö‡∏≤‡∏ó`;
            
            updatePaymentDetails();
        }

        /**
         * üéØ FIXED: ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏Ç‡∏≤‡∏î‡∏´‡∏≤‡∏¢‡πÑ‡∏õ
         * Updates the customer info block based on form inputs.
         */
        function updatePaymentDetails() {
            // Guard clause if elements aren't ready
            if (!nameInput || !emailInput || !totalDisplay || !methodSelect || !paymentInfoContainer) return;

            const name = nameInput.value.trim() || "[‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠]";
            const email = emailInput.value.trim() || "[‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏≠‡∏µ‡πÄ‡∏°‡∏•]";
            const total = totalDisplay.textContent; 
            const methodText = methodSelect.options[methodSelect.selectedIndex].text;
            
            document.getElementById('customer-info-name').textContent = name;
            document.getElementById('customer-info-email').textContent = email;
            document.getElementById('customer-info-total').textContent = total;
            
            if (!paymentInfoContainer.classList.contains('hidden')) {
                 const shopMethodEl = document.getElementById('shop-payment-method');
                 if (methodSelect.value === "") {
                     shopMethodEl.textContent = "N/A";
                 } else {
                     shopMethodEl.textContent = methodText;
                 }
            }
        }

        /**
         * Shows payment info (QR/Link) based on selected method.
         */
        function togglePaymentInfo() {
            const method = methodSelect.value;
            calculateFee(); // This runs first and calls updatePaymentDetails()
            
            if (!promptpayInfo || !truemoneyInfo || !paymentInfoContainer) return;

            promptpayInfo.classList.add('hidden');
            truemoneyInfo.classList.add('hidden');
            paymentInfoContainer.classList.add('hidden');
            
            // üéØ Get the shop method span
            const shopMethodEl = document.getElementById('shop-payment-method'); 

            if (method) {
                 paymentInfoContainer.classList.remove('hidden');
            }

            if (method === 'PromptPay') {
                // üéØ FIXED: ‡∏•‡∏ö‡∏Å‡∏≤‡∏£‡∏™‡∏£‡πâ‡∏≤‡∏á QR ‡πÅ‡∏ö‡∏ö‡πÑ‡∏î‡∏ô‡∏≤‡∏°‡∏¥‡∏Å‡∏≠‡∏≠‡∏Å
                // ‡∏õ‡∏•‡πà‡∏≠‡∏¢‡πÉ‡∏´‡πâ‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û QR ‡∏Ñ‡∏á‡∏ó‡∏µ‡πà (static) ‡∏ó‡∏µ‡πà‡∏ï‡∏±‡πâ‡∏á‡πÑ‡∏ß‡πâ‡πÉ‡∏ô HTML
                // const amount = parseFloat(amountInput.value) || 0;
                // const total = amount; 
                //  try {
                //    const qrText = `PromptPay ID: [Your ID] | Amount: ${total.toFixed(2)}`;
                //    promptpayInfo.querySelector('img').src = `https://api.qrserver.com/v1/create-qr-code/?size=250x250&data=${encodeURIComponent(qrText)}`;
                //  } catch (e) {
                //      promptpayInfo.querySelector('img').src = 'https://placehold.co/250x250/000000/FFD700?text=QR+Gen+Error';
                //      console.error("Error generating PromptPay QR:", e);
                //  }

                promptpayInfo.classList.remove('hidden');
                if(shopMethodEl) shopMethodEl.textContent = "PromptPay"; // üéØ Set method text

            } else if (method === 'TrueMoney') {
                // QR TrueMoney Wallet
                truemoneyInfo.querySelector('img').src = `https://api.qrserver.com/v1/create-qr-code/?size=250x250&data=${encodeURIComponent(TRUE_MONEY_BASE_URL)}`; 
                
                truemoneyInfo.classList.remove('hidden');
                if(shopMethodEl) shopMethodEl.textContent = "TrueMoney Wallet"; // üéØ Set method text
            } else {
                if(shopMethodEl) shopMethodEl.textContent = "N/A"; // Handle "select"
            }
            
            // Ensure details are updated
            updatePaymentDetails();
        }
        
        /**
         * Shows the slip viewer modal.
         * @param {string} url The URL of the slip image.
         */
        function showSlipModal(url) {
            if (!url || url === 'null' || url === '') {
                showToast("‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÑ‡∏ü‡∏•‡πå‡∏™‡∏•‡∏¥‡∏õ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ", true);
                return;
            }
            
            // üéØ Reset modal state before showing
            const imgEl = document.getElementById('slip-modal-image');
            const errorEl = document.getElementById('slip-modal-error');
            const modalEl = document.getElementById('slip-viewer-modal');
            
            if (imgEl) {
                imgEl.classList.remove('hidden');
                imgEl.src = url; // Set src (this might trigger onerror)
            }
            if (errorEl) errorEl.classList.add('hidden');
            
            // Show the modal
            if (modalEl) modalEl.classList.remove('hidden');
        }

        /**
         * Handles the file input change event to store slip data.
         */
        async function attachSlip(event) {
            const file = event.target.files[0];
            if (!file) {
                slipData = { base64: null, fileName: null, mimeType: null };
                return;
            }
            
            if (file.size > 1024 * 1024 * 5) { // Limit to 5MB
                showToast("‡πÑ‡∏ü‡∏•‡πå‡πÉ‡∏´‡∏ç‡πà‡πÄ‡∏Å‡∏¥‡∏ô 5MB", true);
                event.target.value = null;
                slipData = { base64: null, fileName: null, mimeType: null };
                return;
            }

            showLoading(true);
            try {
                // The base64 string will be a data URL (e.g., data:image/png;base64,iVBORw...)
                const base64String = await fileToBase64(file);
                slipData = {
                    base64: base64String,
                    fileName: file.name,
                    mimeType: file.type
                };
                console.log("Slip attached:", file.name);
            } catch (error) {
                console.error("Error converting file to Base64:", error);
                showToast("‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡πÑ‡∏ü‡∏•‡πå‡∏™‡∏•‡∏¥‡∏õ‡πÑ‡∏î‡πâ", true);
                slipData = { base64: null, fileName: null, mimeType: null };
            } finally {
                showLoading(false);
            }
        }

        /**
         * Validates the payment form.
         * @returns {boolean} True if valid, false otherwise.
         */
        function validateForm() {
            if (!nameInput.value.trim() || !emailInput.value.trim() || !amountInput.value || !methodSelect.value) {
                showToast("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ó‡∏∏‡∏Å‡∏ä‡πà‡∏≠‡∏á", true);
                return false;
            }
            
            // üéØ FIXED: ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö isNaN (Is Not a Number)
            // ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç ‡πÄ‡∏ä‡πà‡∏ô "abc"
            const parsedAmount = parseFloat(amountInput.value);
            if (isNaN(parsedAmount) || parsedAmount <= 0) {
                showToast("‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡πÅ‡∏•‡∏∞‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤ 0", true);
                return false;
            }

            if (!slipData.base64) {
                showToast("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÅ‡∏ô‡∏ö‡∏™‡∏•‡∏¥‡∏õ‡∏Å‡∏≤‡∏£‡πÇ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô", true);
                return false;
            }
            return true;
        }

        /**
         * Handles the payment form submission.
         */
        async function submitPayment(event) {
            event.preventDefault();
            if (!validateForm()) return;

            showLoading(true);

            const amount = parseFloat(amountInput.value); // ‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ‡∏à‡∏∞‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡πÅ‡∏•‡πâ‡∏ß
            const method = methodSelect.value;
            // Calculate fee based on the selected method JUST BEFORE sending
            const fee = (method === 'TrueMoney') ? Math.min(amount * 0.035, 10) : 0;
            const total = amount + fee;
            const name = nameInput.value.trim();
            const email = emailInput.value.trim();

            // Extract the actual base64 part, removing the data URL prefix (e.g., data:image/png;base64,)
            let slipBase64Part = '';
            if (slipData?.base64?.includes(',')) {
                slipBase64Part = slipData.base64.split(',')[1];
            } else {
                 showToast("‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏•‡∏¥‡∏õ‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á ‡πÇ‡∏õ‡∏£‡∏î‡∏•‡∏≠‡∏á‡πÅ‡∏ô‡∏ö‡πÑ‡∏ü‡∏•‡πå‡πÉ‡∏´‡∏°‡πà", true);
                 showLoading(false);
                 return; 
            }

            const payload = {
                action: "addPayment",
                name: name,
                email: email,
                
                // üéØ FIXED (from last time): ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô key ‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏±‡∏ß‡∏û‡∏¥‡∏°‡∏û‡πå‡πÉ‡∏´‡∏ç‡πà (Amount, Fee, Total)
                // ‡πÅ‡∏•‡∏∞‡∏™‡πà‡∏á‡πÄ‡∏õ‡πá‡∏ô Number (‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç)
                Amount: amount, 
                Fee: fee,       
                Total: total,   
                
                // üéØüéØüéØ FIX (‡∏Å‡∏±‡∏ô‡πÄ‡∏´‡∏ô‡∏µ‡∏¢‡∏ß): üéØüéØüéØ
                // ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏±‡∏ß‡∏û‡∏¥‡∏°‡∏û‡πå‡πÄ‡∏•‡πá‡∏Å‡πÑ‡∏õ‡∏î‡πâ‡∏ß‡∏¢ ‡πÄ‡∏ú‡∏∑‡πà‡∏≠‡∏ß‡πà‡∏≤ GAS ‡∏ó‡∏µ‡πà Deploy ‡∏≠‡∏¢‡∏π‡πà‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏Å‡πà‡∏≤
                amount: amount,
                fee: fee,
                total: total,

                method: method,
                // ‡πÉ‡∏ä‡πâ ISOString ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ GAS ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ Timezone ‡πÑ‡∏î‡πâ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á
                time: new Date().toISOString(), 
                slipBase64: slipBase64Part, 
                slipFileName: slipData.fileName,
                slipMimeType: slipData.mimeType
            };
            
            try {
                // ‡πÉ‡∏ä‡πâ fetch ‡∏ò‡∏£‡∏£‡∏°‡∏î‡∏≤‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏≤‡∏Å GAS ‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£ Content-Type: text/plain;charset=utf-8 
                // ‡πÅ‡∏•‡∏∞‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö application/json ‡πÇ‡∏î‡∏¢‡∏ï‡∏£‡∏á‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏™‡πà‡∏á POST
                const response = await fetch(SCRIPT_URL, {
                    method: 'POST',
                    mode: 'cors',
                    redirect: 'follow',
                    // ‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏ Content-Type ‡∏à‡∏∞‡∏õ‡∏•‡πà‡∏≠‡∏¢‡πÉ‡∏´‡πâ‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ ‡∏´‡∏£‡∏∑‡∏≠‡∏ñ‡πâ‡∏≤‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡πá‡∏ô text/plain
                    headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                    body: JSON.stringify(payload)
                });
                
                // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö response ‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô JSON ‡πÅ‡∏•‡∏∞‡∏≠‡πà‡∏≤‡∏ô‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå
                const responseText = await response.text();
                let result;
                try {
                     result = JSON.parse(responseText);
                } catch (e) {
                     console.error("Failed to parse JSON response:", responseText, e);
                     throw new Error("‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á");
                }


                if (result.status === "success") {
                    showToast("‡∏ó‡∏≥‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏ï‡∏¥‡∏°‡πÄ‡∏á‡∏¥‡∏ô‡πÅ‡∏•‡πâ‡∏ß ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö"); 
                    saveUserData(name, email); // Save data on success
                    
                    // üéØ FIXED: ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏ü‡∏≠‡∏£‡πå‡∏°‡πÅ‡∏•‡∏∞‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å (‡∏ï‡∏≤‡∏°‡∏Ñ‡∏≥‡∏Ç‡∏≠)
                    paymentForm.reset();
                    slipData = { base64: null, fileName: null, mimeType: null };
                    calculateFee(); // Reset fee display
                    paymentInfoContainer.classList.add('hidden');

                    // ‡∏´‡∏ô‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤ 2 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏≠‡πà‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° Toast
                    // ‡∏à‡∏≤‡∏Å‡∏ô‡∏±‡πâ‡∏ô‡∏à‡∏∂‡∏á‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏ó‡∏µ‡πà‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å
                    setTimeout(() => {
                        showPage('home-page');
                    }, 2000);

                } else {
                    throw new Error(result.message || "‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•");
                }
            } catch (error) {
                showToast(`‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ${error.message}`, true);
                console.error("Error submitting payment:", error);
            } finally {
                showLoading(false);
            }
        }

        // === Page Logic: History ===

        /**
         * Handles the history form submission or refresh button click.
         * @param {Event | boolean | null} arg - Event object from form submit, true for refresh, or null.
         */
        function searchHistory(arg = null) {
            let evt = null;
            if (arg && typeof arg === 'object' && typeof arg.preventDefault === 'function') {
                evt = arg;
                try { evt.preventDefault(); } catch (e) { console.warn(e); }
            }
            
            if (!historyNameInput || !historyEmailInput || !historyResults) return;

            const name = historyNameInput?.value?.trim() || '';
            const email = historyEmailInput?.value?.trim() || '';

            if (!name || !email) {
                showToast("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏•‡∏∞‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤", true);
                historyResults.innerHTML = '<p class="text-center text-gray-500">‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</p>';
                return;
            }

            showLoading(true);
            historyResults.innerHTML = ''; // Clear previous results

            (async () => {
                try {
                    // Fetch data from Google Apps Script using GET request
                    const response = await fetch(`${SCRIPT_URL}?action=getHistory&name=${encodeURIComponent(name)}&email=${encodeURIComponent(email)}`, { 
                        method: 'GET', 
                        mode: 'cors' 
                    });
                    const result = await response.json();

                    if (result.status === "success" && result.data) {
                        renderHistory(result.data); 
                        saveUserData(name, email); 
                        showToast(`‡∏û‡∏ö ${result.data.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`);
                    } else {
                        historyResults.innerHTML = '<p class="text-center text-gray-500">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥</p>';
                        showToast(result.message || "‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•", true); 
                    }
                } catch (error) {
                    console.error("Error fetching history:", error);
                    historyResults.innerHTML = '<p class="text-center text-gray-500">‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</p>'; 
                    showToast(`‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î: ${error?.message || error}`, true);
                } finally {
                    showLoading(false);
                }
            })(); 
        }

        /**
         * Renders history data into cards.
         * @param {Array<Object>} data Array of transaction objects.
         */
        function renderHistory(data) {
            if (!historyResults) return;
            
            if (!Array.isArray(data)) {
                 historyResults.innerHTML = '<p class="text-center text-gray-500">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î</p>';
                 return;
            }
            if (data.length === 0) {
                historyResults.innerHTML = '<p class="text-center text-gray-500">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥</p>';
                return;
            }

            // Sort by date, newest first
            try {
                data.sort((a, b) => {
                    const dateA = a.Timestamp ? new Date(a.Timestamp).getTime() : 0;
                    const dateB = b.Timestamp ? new Date(b.Timestamp).getTime() : 0;
                    return dateB - dateA; // Sort descending
                });
            } catch (e) {
                console.warn("Could not sort history data, possibly invalid dates:", e);
            }
            
            historyResults.innerHTML = data.map(item => `
                <div class="card p-4 space-y-3 fade-in">
                    <div class="flex flex-col sm:flex-row justify-between sm:items-center">
                        <span class="font-bold text-lg text-white">${formatDateTime(item.Timestamp)}</span>
                        ${formatStatus(item.Status)}
                    </div>
                    <div class="text-sm text-gray-300 grid grid-cols-1 md:grid-cols-2 gap-x-4 gap-y-1">
                        <p><strong>ID:</strong> ${item.ID || 'N/A'}</p>
                        <p><strong>‡∏ä‡∏∑‡πà‡∏≠:</strong> ${item.Name || 'N/A'}</p>
                        <p><strong>‡∏≠‡∏µ‡πÄ‡∏°‡∏•:</strong> ${item.Email || 'N/A'}</p>
                        <p><strong>‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏≤‡∏á:</strong> ${item.Method || 'N/A'}</p>
                        <p><strong>‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô:</strong> ${(item.Amount ?? 0).toFixed(2)} ‡∏ö‡∏≤‡∏ó</p>
                        <p><strong>‡∏Ñ‡πà‡∏≤‡∏ò‡∏£‡∏£‡∏°‡πÄ‡∏ô‡∏µ‡∏¢‡∏°:</strong> ${(item.Fee ?? 0).toFixed(2)} ‡∏ö‡∏≤‡∏ó</p>
                        <p class="md:col-span-2"><strong>‡∏£‡∏ß‡∏°:</strong> <span class="font-bold text-lg text-yellow-400">${(item.Total ?? 0).toFixed(2)} ‡∏ö‡∏≤‡∏ó</span></p>
                    </div>
                    <!-- ‡πÉ‡∏ä‡πâ data attribute ‡πÄ‡∏Å‡πá‡∏ö URL ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡πà‡∏á‡πÑ‡∏õ‡∏¢‡∏±‡∏á showSlipModal -->
                    ${item.SlipURL ? `<button class="btn-secondary btn-show-slip w-full sm:w-auto text-sm" data-slip-url="${item.SlipURL}">‡∏î‡∏π‡∏™‡∏•‡∏¥‡∏õ</button>` : ''} 
                </div>
            `).join('');

            addSlipButtonListeners('history-results'); 
        }

        // === Page Logic: Admin ===

        /**
         * Handles the admin login form submission.
         */
        function loginAdmin(event) {
            event.preventDefault();
            const passwordEl = document.getElementById('admin-password');
            if (!passwordEl || !adminLoginView || !adminDashboardView) return;

            const password = passwordEl.value;
            
            if (password === ADMIN_PASSWORD) {
                currentAdminPassword = password; // Store password
                adminLoginView.classList.add('hidden');
                adminDashboardView.classList.remove('hidden');
                getAllPayments(); // Fetch data on login
            } else {
                showToast("‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á", true);
            }
        }

        /**
         * Logs out the admin.
         */
        function adminLogout() {
            currentAdminPassword = null;
            const passwordEl = document.getElementById('admin-password');
            if (passwordEl) passwordEl.value = '';
            
            if (adminLoginView) adminLoginView.classList.remove('hidden');
            if (adminDashboardView) adminDashboardView.classList.add('hidden');
            if (adminResults) adminResults.innerHTML = '<p class="text-center text-gray-500">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</p>';
            
            showPage('home-page');
        }

        /**
         * Fetches all payment records for the admin.
         */
        async function getAllPayments() {
            if (!currentAdminPassword) {
                showToast("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡πà‡∏≠‡∏ô", true);
                adminLogout(); 
                return;
            }

            showLoading(true);
            if (adminResults) adminResults.innerHTML = '';
            
            try {
                // Fetch data from GAS using GET request with password for authentication
                const response = await fetch(`${SCRIPT_URL}?action=getAllPayments&password=${encodeURIComponent(currentAdminPassword)}`, {
                    method: 'GET',
                    mode: 'cors'
                });
                
                const result = await response.json();

                if (result.status === "success" && result.data) {
                    renderAdminCards(result.data);
                    showToast(`‡∏û‡∏ö ${result.data.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î`);
                } else {
                    throw new Error(result.message || "‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ");
                }
            } catch (error) {
                console.error("Error fetching all payments:", error);
                // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° Error ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏Å‡∏≤‡∏£ Unauthorized
                if (error.message.toLowerCase().includes('unauthorized') || error.message.toLowerCase().includes('password')) {
                    showToast(`‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á ‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏ã‡∏™‡∏ä‡∏±‡πà‡∏ô‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏`, true);
                    adminLogout();
                } else {
                    showToast(`‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ${error.message}`, true);
                    if (adminResults) adminResults.innerHTML = '<p class="text-center text-gray-500">‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</p>'; 
                }
            } finally {
                showLoading(false);
            }
        }

        /**
         * Renders admin cards with action buttons.
         * @param {Array<Object>} data Array of transaction objects.
         */
        function renderAdminCards(data) {
            if (!adminResults) return;

             if (!Array.isArray(data)) {
                 adminResults.innerHTML = '<p class="text-center text-gray-500">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î</p>';
                 return;
             }
            if (data.length === 0) {
                adminResults.innerHTML = '<p class="text-center text-gray-500">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</p>';
                return;
            }
            
            // Sort by date, newest first
            try {
                 data.sort((a, b) => {
                    const dateA = a.Timestamp ? new Date(a.Timestamp).getTime() : 0;
                    const dateB = b.Timestamp ? new Date(b.Timestamp).getTime() : 0;
                    return dateB - dateA;
                });
            } catch (e) {
                console.warn("Could not sort admin data, possibly invalid dates:", e);
            }

            adminResults.innerHTML = data.map(item => `
                <!-- üéØ UPDATED: Card Admin Layout (‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á‡∏ï‡∏≤‡∏° Screenshot) -->
                <div class="card-admin fade-in p-4 md:p-6">
                    
                    <!-- Status Badge (Absolute Position) -->
                    <div class="absolute top-4 right-4">
                        ${formatStatus(item.Status)}
                    </div>
                    
                    <!-- Content Grid (2 Columns) -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-2 text-gray-300 text-sm mb-4">
                        <!-- Left Column -->
                        <div class="space-y-2">
                            <p><strong>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà:</strong> ${formatDateTime(item.Timestamp)}</p>
                            <p><strong>‡∏≠‡∏µ‡πÄ‡∏°‡∏•:</strong> ${item.Email || 'N/A'}</p>
                            <p><strong>‡∏¢‡∏≠‡∏î‡πÄ‡∏ï‡∏¥‡∏°:</strong> ${(item.Amount ?? 0).toFixed(2)} ‡∏ö‡∏≤‡∏ó</p>
                        </div>
                        <!-- Right Column -->
                        <div class="space-y-2">
                            <p><strong>‡∏ä‡∏∑‡πà‡∏≠:</strong> ${item.Name || 'N/A'}</p>
                            <p><strong>‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏≤‡∏á:</strong> ${item.Method || 'N/A'}</p>
                            <p><strong>‡∏Ñ‡πà‡∏≤‡∏ò‡∏£‡∏£‡∏°‡πÄ‡∏ô‡∏µ‡∏¢‡∏°:</strong> ${(item.Fee ?? 0).toFixed(2)} ‡∏ö‡∏≤‡∏ó</p>
                        </div>
                        <!-- Total Row (Span full width) -->
                        <div class="md:col-span-2 mt-2">
                             <p class="text-lg font-bold text-yellow-400"><strong>‡∏£‡∏ß‡∏°:</strong> ${(item.Total ?? 0).toFixed(2)} ‡∏ö‡∏≤‡∏ó</p>
                        </div>
                    </div>

                    <!-- Button Row (Full width, border top) -->
                    <div class="flex flex-col md:flex-row gap-2 pt-4 border-t border-gray-700">
                        <!-- Slip Button -->
                        <button 
                            class="btn-secondary btn-show-slip text-sm w-full md:w-auto"
                            data-slip-url="${item.SlipURL || ''}" 
                            ${!item.SlipURL || item.SlipURL === 'null' ? 'disabled title="‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏•‡∏¥‡∏õ"' : ''}>
                            ${!item.SlipURL || item.SlipURL === 'null' ? '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏•‡∏¥‡∏õ' : '‡∏î‡∏π‡∏™‡∏•‡∏¥‡∏õ'}
                        </button>
                        
                        <!-- Approve/Reject Buttons (Grow to fill space) -->
                        ${item.Status === '‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥' || item.Status === 'pending' ? `
                            <div class="flex-grow flex flex-col md:flex-row gap-2">
                                <button onclick="updatePaymentStatus('${item.ID}', 'approved', event)" class="btn-approve text-sm font-bold py-2 px-4 rounded w-full flex-grow" data-item='${JSON.stringify(item)}'>‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥ (APPROVE)</button>
                                <button onclick="updatePaymentStatus('${item.ID}', 'rejected', event)" class="btn-reject text-sm font-bold py-2 px-4 rounded w-full flex-grow" data-item='${JSON.stringify(item)}'>‡πÑ‡∏°‡πà‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥ (REJECT)</button>
                            </div>
                        ` : ''}
                    </div>
                    
                </div>
            `).join('');

            addSlipButtonListeners('admin-results');
        } // üéØ SYNTAX FIX (REMOVED): ‡∏•‡∏ö } ‡∏ó‡∏µ‡πà‡∏ã‡πâ‡∏≥‡∏ã‡πâ‡∏≠‡∏ô‡∏ã‡∏∂‡πà‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏‡∏Ç‡∏≠‡∏á Error
        
        /**
         * Sends request to approve or reject a payment.
         * @param {string} id The transaction ID.
         * @param {'approved' | 'rejected'} newStatus The new status.
         * @param {Event} event The click event object to get the item data from.
         */
        async function updatePaymentStatus(id, newStatus, event) {
            if (!currentAdminPassword) {
                showToast("‡πÄ‡∏ã‡∏™‡∏ä‡∏±‡πà‡∏ô‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÉ‡∏´‡∏°‡πà", true);
                adminLogout();
                return;
            }
            
            const actionText = newStatus === 'approved' ? '‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥' : '‡πÑ‡∏°‡πà‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥';
            const message = `‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£ [${actionText}] ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ ID: ${id}?`;
            
            // ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏à‡∏≤‡∏Å DOM (‡πÉ‡∏ä‡πâ data-item ‡∏ó‡∏µ‡πà‡πÉ‡∏™‡πà‡πÑ‡∏ß‡πâ‡πÉ‡∏ô‡∏õ‡∏∏‡πà‡∏°)
            const button = event.currentTarget; // ‡πÉ‡∏ä‡πâ event ‡∏ó‡∏µ‡πà‡∏™‡πà‡∏á‡∏°‡∏≤‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á‡∏ñ‡∏∂‡∏á‡∏õ‡∏∏‡πà‡∏°
            if (!button || !button.dataset.item) {
                showToast("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£", true);
                return;
            }
            const itemData = JSON.parse(button.dataset.item);

            // ‡πÉ‡∏ä‡πâ custom modal ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô
            showConfirmModal(message, async () => {
                closeConfirmModal(); // ‡∏õ‡∏¥‡∏î modal ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ‡∏ó‡∏µ‡πà‡∏Å‡∏î‡∏ï‡∏Å‡∏•‡∏á
                showLoading(true);
                
                const payload = {
                    action: 'updateStatus',
                    id: id,
                    status: newStatus,
                    password: currentAdminPassword,
                    // üéØ ‡πÄ‡∏û‡∏¥‡πà‡∏° flag ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏≠‡∏µ‡πÄ‡∏°‡∏•
                    sendEmailToCustomer: true, // ‡∏™‡πà‡∏á‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡πÉ‡∏´‡πâ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤
                    sendEmailToShop: true,      // ‡∏™‡πà‡∏á‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡πÅ‡∏à‡πâ‡∏á‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤
                    // üéØ ‡πÅ‡∏ô‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡∏£‡πâ‡∏≤‡∏á PDF (ID, Email, Name, Total)
                    customerData: {
                        ID: itemData.ID,
                        Email: itemData.Email,
                        Name: itemData.Name,
                        Amount: itemData.Amount,
                        Fee: itemData.Fee,
                        Total: itemData.Total,
                        Timestamp: itemData.Timestamp,
                        Method: itemData.Method
                    },
                    shopEmail: SHOP_EMAIL // ‡∏™‡πà‡∏á‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤‡πÑ‡∏õ‡∏î‡πâ‡∏ß‡∏¢
                };
                
                try {
                    const response = await fetch(SCRIPT_URL, {
                        method: 'POST',
                        mode: 'cors',
                        redirect: 'follow',
                        headers: {
                            'Content-Type': 'text/plain;charset=utf-8',
                        },
                        body: JSON.stringify(payload)
                    });
                    
                    const responseText = await response.text();
                    let result;
                    try {
                         result = JSON.parse(responseText);
                    } catch (e) {
                         console.error("Failed to parse JSON response:", responseText, e);
                         throw new Error("‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á");
                    }

                    if (result.status === "success") {
                        // üí° ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÉ‡∏´‡πâ‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô‡∏Ç‡∏∂‡πâ‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÑ‡∏°‡πà‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥
                        let toastMessage = `‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏õ‡πá‡∏ô [${actionText}] ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à`;
                        if (newStatus === 'approved') {
                            toastMessage += " ‡πÅ‡∏•‡∏∞‡∏™‡πà‡∏á‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡πÉ‡∏´‡πâ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÅ‡∏•‡πâ‡∏ß";
                        } else {
                            toastMessage += " (‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à)";
                        }
                        showToast(toastMessage);
                        getAllPayments(); // Refresh the list
                    } else {
                        throw new Error(result.message || "‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
                    }
                } catch (error) {
                    console.error("Error updating status:", error);
                    showToast(`‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ${error.message}`, true);
                     if (error.message.toLowerCase().includes('unauthorized') || error.message.toLowerCase().includes('password')) {
                        adminLogout();
                    }
                } finally {
                    showLoading(false);
                }
            });
        }

        // === Event Listeners ===
        // üéØ FIXED: ‡∏¢‡πâ‡∏≤‡∏¢‡∏™‡πà‡∏ß‡∏ô‡∏ô‡∏µ‡πâ‡∏°‡∏≤‡πÑ‡∏ß‡πâ‡πÉ‡∏ô DOMContentLoaded
        document.addEventListener('DOMContentLoaded', () => {
            
            // --- Assign DOM Elements ---
            pages = document.querySelectorAll('.page');
            amountInput = document.getElementById('amount');
            feeDisplay = document.getElementById('fee-display');
            totalDisplay = document.getElementById('total-display');
            feeDisplayRow = document.getElementById('fee-display-row'); 
            methodSelect = document.getElementById('method');
            paymentInfoContainer = document.getElementById('payment-info-container');
            promptpayInfo = document.getElementById('promptpay-info');
            truemoneyInfo = document.getElementById('truemoney-info');
            slipInput = document.getElementById('slip');
            paymentForm = document.getElementById('payment-form');
            historyForm = document.getElementById('history-form');
            adminLoginForm = document.getElementById('admin-login-form');
            historyResults = document.getElementById('history-results');
            adminResults = document.getElementById('admin-results');
            adminLoginView = document.getElementById('admin-login-view');
            adminDashboardView = document.getElementById('admin-dashboard-view');
            historyNameInput = document.getElementById('history-name');
            historyEmailInput = document.getElementById('history-email');
            nameInput = document.getElementById('name');
            emailInput = document.getElementById('email');

            // --- Setup Event Listeners ---
            
            // Setup Payment Page
            if (amountInput) amountInput.addEventListener('input', calculateFee); 
            if (methodSelect) methodSelect.addEventListener('change', togglePaymentInfo); 
            if (slipInput) slipInput.addEventListener('change', attachSlip);
            if (paymentForm) paymentForm.addEventListener('submit', submitPayment); 
            
            // Setup History Page
            if (historyForm) historyForm.addEventListener('submit', searchHistory); 
            
            // Setup Admin Page
            if (adminLoginForm) adminLoginForm.addEventListener('submit', loginAdmin);

            // Setup confirm modal buttons
            const confirmCancel = document.getElementById('confirm-modal-cancel');
            const confirmConfirm = document.getElementById('confirm-modal-confirm');
            
            if (confirmCancel) confirmCancel.addEventListener('click', closeConfirmModal);
            if (confirmConfirm) confirmConfirm.addEventListener('click', () => {
                if (typeof confirmCallback === 'function') {
                    confirmCallback(); 
                }
            });

            // Show home page on load
            showPage('home-page');
            calculateFee(); // Initial calculation on load
        });

    </script>
</head>
<body class="min-h-screen flex items-center justify-center p-4">

    <div id="app-container" class="w-full max-w-4xl mx-auto">

        <!-- ===== Page: Home ===== -->
        <div id="home-page" class="page text-center fade-in">
            <h1 class="text-5xl md:text-7xl font-bold glow-gold mb-4 font-orbitron">QuantumXP</h1>
            <h2 class="text-xl md:text-2xl font-bold glow-gold-soft mb-8 font-orbitron">Payment System</h2>
            
            <p class="text-lg text-gray-300 mb-12 max-w-md mx-auto">
                ‚Äú‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏ï‡∏¥‡∏°‡πÄ‡∏á‡∏¥‡∏ô‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥ QuantumXP ‚Äî ‡∏£‡∏ß‡∏î‡πÄ‡∏£‡πá‡∏ß ‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢ ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÑ‡∏î‡πâ‚Äù
            </p>

            <div class="space-y-6 md:space-y-0 md:space-x-6 flex flex-col md:flex-row justify-center">
                <button onclick="showPage('payment-page')" class="btn-primary flex items-center justify-center">
                    <!-- Icon for Payment -->
                    <!-- üéØ UPDATED: ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÑ‡∏≠‡∏Ñ‡∏≠‡∏ô‡πÄ‡∏õ‡πá‡∏ô "‡∏ö‡∏±‡∏ï‡∏£‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï" -->
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-3 icon-glow" fill="none" viewBox="0 0 24 24" stroke-width="2">
                      <path stroke-linecap="round" stroke-linejoin="round" d="M2.25 8.25h19.5M2.25 9h19.5m-16.5 5.25h6m-6 2.25h6m3-3.75l-3 3m3 0l-3-3m-3.75 6.75h16.5a2.25 2.25 0 0 0 2.25-2.25V6.75a2.25 2.25 0 0 0-2.25-2.25H3.75a2.25 2.25 0 0 0-2.25 2.25v10.5a2.25 2.25 0 0 0 2.25 2.25Z" />
                    </svg>
                    ‡∏ó‡∏≥‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏ï‡∏¥‡∏°‡πÄ‡∏á‡∏¥‡∏ô
                </button>
                <button onclick="showPage('history-page')" class="btn-primary flex items-center justify-center">
                    <!-- Icon for History -->
                    <!-- üéØ UPDATED: ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÑ‡∏≠‡∏Ñ‡∏≠‡∏ô‡πÄ‡∏õ‡πá‡∏ô "‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à" -->
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-3 icon-glow" fill="none" viewBox="0 0 24 24" stroke-width="2">
                      <path stroke-linecap="round" stroke-linejoin="round" d="M3.75 9.75h16.5m-16.5 3.75h16.5M3.75 17.25h16.5M4.5 3.75h15a2.25 2.25 0 0 1 2.25 2.25v12a2.25 2.25 0 0 1-2.25 2.25h-15a2.25 2.25 0 0 1-2.25-2.25v-12a2.25 2.25 0 0 1 2.25-2.25Z" />
                    </svg>
                    ‡∏î‡∏π‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô
                </button>
                <button onclick="showPage('admin-page')" class="btn-primary flex items-center justify-center">
                    <!-- Icon for Admin -->
                    <!-- üéØ UPDATED: ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÑ‡∏≠‡∏Ñ‡∏≠‡∏ô‡πÄ‡∏õ‡πá‡∏ô "‡∏Å‡∏∏‡∏ç‡πÅ‡∏à" (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Login/Access) -->
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-3 icon-glow" fill="none" viewBox="0 0 24 24" stroke-width="2">
                      <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 5.25a3 3 0 0 1 3 3m3 0a6 6 0 0 1-7.029 5.912c-.563-.097-1.159.026-1.563.43L10.5 17.25H8.25v2.25H6v2.25H3.75v-2.25H1.5v-2.25H.75C.336 17.25 0 16.914 0 16.5v-3c0-.414.336-.75.75-.75h1.5V9.75h2.25V7.5h2.25V5.25A3 3 0 0 1 15.75 5.25Z" />
                    </svg>
                    ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•
                </button>
            </div>

            <footer class="mt-24 text-gray-500">
                ¬© 2025 QXP ‚Äì Powered by QuantumXP Payment System
            </footer>
        </div>

        <!-- ===== Page: Payment ===== -->
        <div id="payment-page" class="page hidden fade-in">
            <h1 class="text-4xl font-bold glow-gold-soft mb-8 text-center font-orbitron">‡∏ó‡∏≥‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏ï‡∏¥‡∏°‡πÄ‡∏á‡∏¥‡∏ô</h1>
            
            <form id="payment-form" class="card p-6 md:p-8 space-y-6">
                <!-- üéØ UPDATED: ‡πÄ‡∏û‡∏¥‡πà‡∏° Grid wrapper ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö ‡∏ä‡∏∑‡πà‡∏≠ ‡πÅ‡∏•‡∏∞ ‡∏≠‡∏µ‡πÄ‡∏°‡∏• -->
                <div class="grid grid-cols-1 md:grid-cols-2 md:gap-6 space-y-6 md:space-y-0">
                    <div>
                        <label for="name" class="block mb-2 text-sm font-medium">‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏• (‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á‡∏ï‡∏≤‡∏°‡∏™‡∏•‡∏¥‡∏õ)</label>
                        <!-- üéØ ADDED: oninput event to update details -->
                        <input type="text" id="name" class="form-input" placeholder="‡πÄ‡∏ä‡πà‡∏ô: QuantumPlayer" required oninput="updatePaymentDetails()">
                    </div>

                    <div>
                        <label for="email" class="block mb-2 text-sm font-medium">‡∏≠‡∏µ‡πÄ‡∏°‡∏• (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏£‡∏±‡∏ö‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à)</label>
                        <!-- üéØ ADDED: oninput event to update details -->
                        <input type="email" id="email" class="form-input" placeholder="player@example.com" required oninput="updatePaymentDetails()">
                    </div>
                </div> <!-- üéØ END: Grid wrapper -->

                <!-- ‚ùå REMOVED: ‡∏•‡∏ö‡∏ä‡πà‡∏≠‡∏á‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏ó‡∏µ‡πà‡∏ã‡πâ‡∏≥‡∏ã‡πâ‡∏≠‡∏ô‡∏≠‡∏≠‡∏Å -->
                <!-- ... (existing comment) ... -->

                <!-- üéØ UPDATED: ‡πÄ‡∏û‡∏¥‡πà‡∏° Grid wrapper ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô ‡πÅ‡∏•‡∏∞ ‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏≤‡∏á -->
                <div class="grid grid-cols-1 md:grid-cols-2 md:gap-6 space-y-6 md:space-y-0">
                    <div>
                        <label for="amount" class="block mb-2 text-sm font-medium">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô (‡∏ö‡∏≤‡∏ó)</label>
                        <input type="number" id="amount" class="form-input" placeholder="0" min="1" required>
                    </div>

                    <!-- üéØ ADDED BACK: ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ä‡πà‡∏≠‡∏á‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏≤‡∏á‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô‡∏ó‡∏µ‡πà‡∏´‡∏≤‡∏¢‡πÑ‡∏õ‡∏Å‡∏•‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤‡∏°‡∏≤ -->
                    <div>
                        <label for="method" class="block mb-2 text-sm font-medium">‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏≤‡∏á‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô</label>
                        <select id="method" class="form-select" required>
                            <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏≤‡∏á --</option>
                            <option value="PromptPay">PromptPay (QR Code)</option>
                            <option value="TrueMoney">TrueMoney Wallet</option>
                        </select>
                    </div>
                </div> <!-- üéØ END: Grid wrapper -->

                <div class="text-sm space-y-1 text-gray-300">
                    <!-- Fee display row, hidden by default -->
                    <div id="fee-display-row" class="hidden flex justify-between">
                        <span>‡∏Ñ‡πà‡∏≤‡∏ò‡∏£‡∏£‡∏°‡πÄ‡∏ô‡∏µ‡∏¢‡∏° TrueMoney (3.5%, ‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î 10 ‡∏ö‡∏≤‡∏ó):</span>
                        <span id="fee-display">0.00 ‡∏ö‡∏≤‡∏ó</span>
                    </div>
                    <div class="flex justify-between font-bold text-lg text-white">
                        <span>‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ä‡∏≥‡∏£‡∏∞:</span>
                        <span id="total-display" class="text-yellow-400">0.00 ‡∏ö‡∏≤‡∏ó</span>
                    </div>
                </div>
                
                <!-- üéØ UPDATED: Payment Info Display (Layout Changed) -->
                <div id="payment-info-container" class="hidden card p-4 md:p-6 bg-gray-900">
                    
                    <p class="text-lg text-center mb-6">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏™‡πÅ‡∏Å‡∏ô QR Code ‡πÅ‡∏•‡∏∞‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</p>

                    <!-- Flex Wrapper: QR on Left, Info on Right (on desktop) -->
                    <div class="flex flex-col md:flex-row md:items-start md:gap-8 justify-center">
                        
                        <!-- Left Side: QR Codes -->
                        <div class="flex-shrink-0 text-center mx-auto">
                            <div id="promptpay-info" class="hidden flex-col items-center">
                                <!-- üéØ FIXED: ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏•‡∏¥‡∏á‡∏Å‡πå QR Code -->
                                <img src="https://img2.pic.in.th/pic/1000118820.png" 
                                     onerror="this.src='https://placehold.co/250x250/000000/FFD700?text=QR+Error'"
                                     alt="PromptPay QR Code" class="w-48 h-48 md:w-56 md:h-56 rounded-lg border-2 border-yellow-400">
                                <!-- üéØ FIXED: ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ä‡∏∑‡πà‡∏≠‡∏ö‡∏±‡∏ç‡∏ä‡∏µ -->
                                <p class="mt-2 text-sm">‡∏ä‡∏∑‡πà‡∏≠‡∏ö‡∏±‡∏ç‡∏ä‡∏µ: ‡∏õ‡∏ß‡∏±‡∏ï‡∏ô‡πå ‡∏ô‡∏∞‡∏î‡∏≤‡∏ö‡∏∏‡∏ï‡∏£</p>
                            </div>
                            <div id="truemoney-info" class="hidden flex-col items-center">
                                <img src="https://api.qrserver.com/v1/create-qr-code/?size=250x250&data=https://tmn.app.link/FDbs0oeDGXb" 
                                     alt="TrueMoney QR Code" class="w-48 h-48 md:w-56 md:h-56 rounded-lg border-2 border-yellow-400">
                                <p class="mt-2 text-sm">‡∏•‡∏¥‡πâ‡∏á‡∏Ñ‡πå TrueMoney (‡∏°‡∏µ‡∏Ñ‡πà‡∏≤‡∏ò‡∏£‡∏£‡∏°‡πÄ‡∏ô‡∏µ‡∏¢‡∏° 3.5%)</p>
                            </div>
                        </div>

                        <!-- Right Side: Info Block (NEW) -->
                        <div id="payment-details-block" class="text-left mt-6 md:mt-0 flex-grow max-w-sm mx-auto md:mx-0">
                            
                            <!-- Shop Info -->
                            <div>
                                <h4 class="font-bold text-lg text-white mb-2 font-orbitron">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏≤‡∏á‡∏£‡πâ‡∏≤‡∏ô</h4>
                                <div class="space-y-1 text-sm text-gray-300 bg-gray-800 p-3 rounded-md">
                                    <p><strong>‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö:</strong> <span id="shop-recipient-name">‡∏õ‡∏ß‡∏±‡∏ï‡∏ô‡πå ‡∏ô‡∏∞‡∏î‡∏≤‡∏ö‡∏∏‡∏ï‡∏£</span></p>
                                    <p><strong>‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡πÇ‡∏≠‡∏ô:</strong> <span id="shop-payment-method" class="text-yellow-400">N/A</span></p>
                                    <p><strong>‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠:</strong> <span id="shop-contact-info">quantumxp.payment@gmail.com</span></p>
                                </div>
                            </div>

                            <!-- Customer Info -->
                            <div class="mt-4 pt-4 border-t border-gray-700">
                                <h4 class="font-bold text-lg text-white mb-2 font-orbitron">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</h4>
                                <div class="space-y-1 text-sm text-gray-300 bg-gray-800 p-3 rounded-md">
                                    <p><strong>‡∏£‡∏´‡∏±‡∏™‡∏ò‡∏∏‡∏£‡∏Å‡∏£‡∏£‡∏°:</strong> <span id="customer-info-txid" class="text-gray-400">[‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô]</span></p>
                                    <p><strong>‡∏ä‡∏∑‡πà‡∏≠:</strong> <span id="customer-info-name">[‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠]</span></p>
                                    <p><strong>‡∏≠‡∏µ‡πÄ‡∏°‡∏•:</strong> <span id="customer-info-email">[‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏≠‡∏µ‡πÄ‡∏°‡∏•]</span></p>
                                    <p class="font-bold text-lg mt-2"><strong>‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°:</strong> <span id="customer-info-total" class="text-yellow-400">0.00 ‡∏ö‡∏≤‡∏ó</span></p>
                                </div>
                            </div>

                        </div>
                    </div>
                    
                    <!-- üéØ MOVED: ‡∏¢‡πâ‡∏≤‡∏¢‡∏™‡πà‡∏ß‡∏ô‡πÅ‡∏ô‡∏ö‡∏™‡∏•‡∏¥‡∏õ‡∏°‡∏≤‡πÑ‡∏ß‡πâ‡πÉ‡∏ô‡∏Å‡∏£‡∏≠‡∏ö‡∏ô‡∏µ‡πâ -->
                    <div class="mt-6 pt-6 border-t border-gray-700">
                        <label for="slip" class="block mb-2 text-sm font-medium">‡πÅ‡∏ô‡∏ö‡∏™‡∏•‡∏¥‡∏õ‡πÇ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô</label>
                        <input type="file" id="slip" class="form-input file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-yellow-400 file:text-black hover:file:bg-yellow-300" accept="image/png, image/jpeg, image/jpg" required>
                        <p class="text-xs text-gray-400 mt-1">‡πÑ‡∏ü‡∏•‡πå .jpg, .png ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô</p>
                    </div>
                </div>

                <!-- ‚ùå REMOVED: ‡∏•‡∏ö‡∏™‡πà‡∏ß‡∏ô‡πÅ‡∏ô‡∏ö‡∏™‡∏•‡∏¥‡∏õ‡∏à‡∏≤‡∏Å‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡πÄ‡∏î‡∏¥‡∏° -->
                
                <div class="pt-4 flex flex-col md:flex-row gap-4">
                    <button type="submit" class="btn-primary w-full">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ï‡∏¥‡∏°‡πÄ‡∏á‡∏¥‡∏ô</button>
                    <button type="button" onclick="showPage('home-page')" class="btn-secondary w-full">‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å</button>
                </div>
            </form>
        </div>

        <!-- ===== Page: History ===== -->
        <div id="history-page" class="page hidden fade-in">
            <h1 class="text-4xl font-bold glow-gold-soft mb-8 text-center font-orbitron">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏ò‡∏∏‡∏£‡∏Å‡∏£‡∏£‡∏°</h1>
            
            <form id="history-form" class="card p-6 md:p-8 space-y-4 mb-6">
                <p class="text-center text-gray-300">‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏•‡∏∞‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</p>
                <div>
                    <label for="history-name" class="block mb-2 text-sm font-medium">‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</label>
                    <input type="text" id="history-name" class="form-input" placeholder="QuantumPlayer" required>
                </div>
                <div>
                    <label for="history-email" class="block mb-2 text-sm font-medium">‡∏≠‡∏µ‡πÄ‡∏°‡∏•</label>
                    <input type="email" id="history-email" class="form-input" placeholder="player@example.com" required>
                </div>
                <div class="pt-2 flex flex-col md:flex-row gap-4">
                    <button type="submit" class="btn-primary w-full">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥</button>
                    <!-- Refreshes history using the current form data -->
                    <button type="button" onclick="searchHistory(true)" class="btn-secondary w-full md:w-auto">‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä</button> 
                </div>
            </form>

            <div id="history-results" class="space-y-4">
                <!-- History cards will be injected here -->
                <p class="text-center text-gray-500">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥</p>
            </div>
            
            <button type="button" onclick="showPage('home-page')" class="btn-secondary w-full mt-8">‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å</button>
        </div>

        <!-- ===== Page: Admin ===== -->
        <div id="admin-page" class="page hidden fade-in">
            <h1 class="text-4xl font-bold glow-gold-soft mb-8 text-center font-orbitron">‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö</h1>

            <!-- Admin Login -->
            <div id="admin-login-view">
                <form id="admin-login-form" class="card p-6 md:p-8 space-y-4">
                    <div>
                        <label for="admin-password" class="block mb-2 text-sm font-medium">‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•</label>
                        <input type="password" id="admin-password" class="form-input" required>
                    </div>
                    <button type="submit" class="btn-primary w-full">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
                </form>
            </div>

            <!-- Admin Dashboard (Hidden by default) -->
            <div id="admin-dashboard-view" class="hidden space-y-6">
                <div class="flex justify-between items-center">
                    <h2 class="text-2xl font-bold font-orbitron">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</h2>
                    <button onclick="getAllPayments()" class="btn-secondary">‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
                </div>
                
                <div id="admin-results" class="space-y-4">
                    <!-- Admin cards will be injected here -->
                    <p class="text-center text-gray-500">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</p>
                </div>
            </div>
            
            <button type="button" onclick="adminLogout()" class="btn-secondary w-full mt-8">‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å</button>
        </div>
    </div>

    <!-- ===== Modals ===== -->

    <!-- Loading Overlay -->
    <div id="loading-overlay" class="hidden fixed inset-0 z-50 modal-backdrop flex items-center justify-center">
        <div class="spinner w-16 h-16 border-4 border-gray-600 rounded-full"></div>
        <span class="ml-4 text-lg text-white font-orbitron">Loading...</span>
    </div>

    <!-- Toast Notification -->
    <div id="toast-notification" class="hidden fixed bottom-5 right-5 z-50 px-6 py-3 rounded-lg text-white font-bold fade-in">
        <span id="toast-message"></span>
    </div>

    <!-- Slip Viewer Modal -->
    <div id="slip-viewer-modal" class="hidden fixed inset-0 z-40 modal-backdrop flex items-center justify-center p-4">
        <div class="modal-content rounded-lg p-4 max-w-lg w-full relative">
            <h3 class="text-2xl font-bold mb-4 font-orbitron text-center">‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏™‡∏•‡∏¥‡∏õ</h3>
            
            <!-- üéØ Image (visible by default) -->
            <img id="slip-modal-image" src="" alt="Slip Preview" class="w-full h-auto max-h-[70vh] object-contain rounded" 
                 onerror="handleSlipImageError(this)">
            
            <!-- üéØ Error Message (hidden by default, shown on error) -->
            <div id="slip-modal-error" class="hidden text-center text-yellow-300 bg-gray-900 p-4 rounded-lg border border-yellow-500 my-4">
                <p>‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏≤‡∏Å‡∏Å‡∏≤‡∏£‡∏î‡∏π‡∏™‡∏•‡∏¥‡∏õ‡∏ô‡∏µ‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢‡πÇ‡∏õ‡∏£‡∏î‡∏ï‡∏¥‡∏î‡∏ó‡∏≤‡∏á‡∏£‡πâ‡∏≤‡∏ô‡∏´‡∏£‡∏∑‡∏≠‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö</p>
                <p class="font-bold mt-2">quantumxp.payment@gmail.com</p>
            </div>

            <button onclick="closeModal('slip-viewer-modal')" class="btn-secondary w-full mt-4">‡∏õ‡∏¥‡∏î</button>
        </div>
    </div>

    <!-- Confirmation Modal (Used for Admin Actions) -->
    <div id="confirm-modal" class="hidden fixed inset-0 z-50 modal-backdrop flex items-center justify-center p-4">
        <div class="modal-content rounded-lg p-6 max-w-sm w-full relative text-center">
            <h3 class="text-xl font-bold mb-4 font-orbitron text-center">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</h3>
            <p id="confirm-modal-message" class="text-gray-300 mb-6"></p>
            <div class="flex justify-center gap-4">
                <button id="confirm-modal-cancel" class="btn-secondary w-full">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                <button id="confirm-modal-confirm" class="btn-primary w-full bg-green-500 hover:bg-green-600 border-green-500 hover:border-green-600">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô</button>
            </div>
        </div>
    </div>

    <!-- ‚ùå REMOVED: ‡∏¢‡πâ‡∏≤‡∏¢‡∏™‡∏Ñ‡∏£‡∏¥‡∏õ‡∏ï‡πå‡πÑ‡∏õ‡πÑ‡∏ß‡πâ‡πÉ‡∏ô <head> ‡πÅ‡∏•‡πâ‡∏ß -->
    <!-- <script> ... </script> -->
</body>
</html>
